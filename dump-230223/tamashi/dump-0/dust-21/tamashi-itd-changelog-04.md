# build 4

## Задачи
Spent: 56.08h
- Feature #6459: Правки по "Кор, этажи". ET: 8/10/12=10. Spent: 9.33h.
- Feature #6460: Правки по "Кор, юниты". ET: 8/10/12=10. Spent: 11.75h.
- Feature #6461: Правки по "Спринты". ET: 8/10/12=10. Spent: 8h.
- Refactoring #6529: Переработать драфтовую логику в подобающую архитектуру. ET: 12/16/20=16. Spent: 19h.
- Feature #6597: Добавить pixi.js рендер в проект. ET: 6/8/10=8. Spent: 8h.
## Изменения
### Конфиг
Новые свойства:
- `psources.rankLevels`, `game.floors_rank_names`
- `employees.stage`, `gadgets.stage`
- `employees.upgradeCosts`, `gadgets.upgradeCosts`
- Для `employees`, `gadgets`: `icon`, `animation`; `looppacks.icon`
- `game.battle_rewards_lootpacks`

Новые разделы:
- `tasks`
- `pools`
### Визуал
- Добавлена отрисовка анимаций для менеджеров и оборудования, расположение на этаже.
- Добавлена графика: тестовые анимации `test-anim-idle`, `test-anim-idle-gadget`; текстура для фона этажей; иконки для тестовых сущностей.
- Доработаны окна: магазин сундуков, награда за спринт.
- Общие доработки стилей, мелкие исправления.

### Механики
- Добавлено отображение рангов этажей (`psources.rankLevels`, `game.floors_rank_names`), конфигурируемые названия и уровни.
- Добавлена привязка карточек предметов к локациям (`employees.stage`, `gadgets.stage`).
- Добавлены свойства стоимости улучшений и максимального уровня карточек (`employees.upgradeCosts`, `gadgets.upgradeCosts`).
- Добавлена механика "выгорания" (смерти) менеджера и его перезарядки.
- Улучшен скролл перетягиванием на экране локаций - исправлены ошибки срабатывания случайных нажатий.
- Улучшена логика взаимодействия с этажами: добавлены состояния кнопок, убраны лишние срабатывания кликов, общие исправления.
### Лутпаки (сундуки)
- Добавлены "шанс" и "вес" для контента сундуков.
- Проработана логика выпадения карточек (оборудования, менеджеров) и предметов.
- Добавлены `pools` для контента сундуков.
### Спринты (бой)
- Новый раздел конфига: `tasks`. Логика использует конфигурируемые юниты.
- Доработана логика спавна: таски и спринты используют систему "веса", добавлен рандом генерации.
- Улучшен темп и читаемость боя.
- Добавлена возможность кликать на таски, урон от кликов подвязан к уровню этажа.
- Конфигурируемая награда за бой (`game.battle_rewards_lootpacks`).
- Прогресс уровня спринтов для каждой локации.
- Исправлена работа step боя.

### Код, файлы
- Логика рендера этажей полностью разнесена по отдельным системам. `RenderBaseRoomHtmlSystem`, `RenderRoomStatusHtmlSystem`, `RenderBattleHtmlSystem` для html части, `RenderRoomPixiContainersSystem`, `RenderRoomElementsPixiSystem` для webgl.
- Добавлена логика рендера через pixi, добавлен рендер элементов комнаты через webgl. Добавлен класс `PixiRender`
- Исправления отрисовки окна локаций, почищен класс `OfficeView`.
- Доработка логики `BattlePrepareView`, `BattleResultsView`, `RoomDetailsView`, `ShopView`.
- Текстуры `res/img`: `textures.png`, `textures.less` для html текстур; `webgl-textures-0.json`, `webgl-textures-0.png`.